version: "3"

tasks:
  # Deploy tasks
  deploy:all:
    desc: Deploy all Kubernetes resources
    cmds:
      - task: deploy:namespace
      - task: deploy:volumes
      - task: deploy:config-maps
      - task: deploy:applications
      - task: deploy:ingress

  deploy:namespace:
    desc: Deploy namespace
    cmds:
      - kubectl apply -f namespace.yaml

  deploy:volumes:
    desc: Deploy persistent volume claims
    cmds:
      - kubectl apply -f volumes/

  deploy:config-maps:
    desc: Deploy config maps
    cmds:
      - kubectl apply -f config-maps/

  deploy:applications:
    desc: Deploy all applications
    cmds:
      - kubectl apply -f applications/

  deploy:ingress:
    desc: Deploy ingress resources
    cmds:
      - kubectl apply -f ingress/

  # Individual application deployment
  deploy:client:
    desc: Deploy client application
    cmds:
      - kubectl apply -f applications/client.yaml

  deploy:server:
    desc: Deploy server application
    cmds:
      - kubectl apply -f applications/server.yaml

  deploy:registry:
    desc: Deploy registry application
    cmds:
      - kubectl apply -f applications/registry.yaml

  deploy:registry-ui:
    desc: Deploy registry UI application
    cmds:
      - kubectl apply -f applications/registry-ui.yaml

  deploy:documentation:
    desc: Deploy documentation application
    cmds:
      - kubectl apply -f applications/documentation.yaml

  # Status and monitoring tasks
  status:
    desc: Check status of all resources
    cmds:
      - kubectl get all -n signapse

  status:pods:
    desc: Get pod status
    cmds:
      - kubectl get pods -n signapse

  status:services:
    desc: Get service status
    cmds:
      - kubectl get services -n signapse

  status:ingress:
    desc: Get ingress status
    cmds:
      - kubectl get ingress -n signapse

  status:pvc:
    desc: Get persistent volume claims status
    cmds:
      - kubectl get pvc -n signapse

  # Logs tasks
  logs:client:
    desc: View client logs
    cmds:
      - kubectl logs -n signapse -l app=client --tail=100 -f

  logs:server:
    desc: View server logs
    cmds:
      - kubectl logs -n signapse -l app=server --tail=100 -f

  logs:registry:
    desc: View registry logs
    cmds:
      - kubectl logs -n signapse -l app=registry --tail=100 -f

  logs:registry-ui:
    desc: View registry UI logs
    cmds:
      - kubectl logs -n signapse -l app=registry-ui --tail=100 -f

  logs:documentation:
    desc: View documentation logs
    cmds:
      - kubectl logs -n signapse -l app=documentation --tail=100 -f

  # Describe tasks
  describe:client:
    desc: Describe client resources
    cmds:
      - kubectl describe deployment client -n signapse

  describe:server:
    desc: Describe server resources
    cmds:
      - kubectl describe deployment server -n signapse

  describe:registry:
    desc: Describe registry resources
    cmds:
      - kubectl describe deployment registry -n signapse

  # Restart tasks
  restart:client:
    desc: Restart client deployment
    cmds:
      - kubectl rollout restart deployment/client -n signapse

  restart:server:
    desc: Restart server deployment
    cmds:
      - kubectl rollout restart deployment/server -n signapse

  restart:registry:
    desc: Restart registry deployment
    cmds:
      - kubectl rollout restart deployment/registry -n signapse

  restart:all:
    desc: Restart all deployments
    cmds:
      - kubectl rollout restart deployment -n signapse

  # Delete tasks
  delete:all:
    desc: Delete all Kubernetes resources
    cmds:
      - task: delete:ingress
      - task: delete:applications
      - task: delete:config-maps
      - task: delete:namespace

  delete:namespace:
    desc: Delete namespace (and all resources within)
    cmds:
      - kubectl delete -f namespace.yaml

  delete:volumes:
    desc: Delete persistent volume claims
    cmds:
      - kubectl delete -f volumes/

  delete:config-maps:
    desc: Delete config maps
    cmds:
      - kubectl delete -f config-maps/

  delete:applications:
    desc: Delete all applications
    cmds:
      - kubectl delete -f applications/

  delete:ingress:
    desc: Delete ingress resources
    cmds:
      - kubectl delete -f ingress/

  delete:client:
    desc: Delete client application
    cmds:
      - kubectl delete -f applications/client.yaml

  delete:server:
    desc: Delete server application
    cmds:
      - kubectl delete -f applications/server.yaml

  delete:registry:
    desc: Delete registry application
    cmds:
      - kubectl delete -f applications/registry.yaml

  # Port forwarding tasks
  forward:client:
    desc: Forward client port to localhost
    cmds:
      - kubectl port-forward -n signapse service/client 8081:80

  forward:server:
    desc: Forward server port to localhost
    cmds:
      - kubectl port-forward -n signapse service/server 8000:8000

  forward:registry:
    desc: Forward registry port to localhost
    cmds:
      - kubectl port-forward -n signapse service/registry 5000:5000

  forward:registry-ui:
    desc: Forward registry UI port to localhost
    cmds:
      - kubectl port-forward -n signapse service/registry-ui 8082:80

  forward:documentation:
    desc: Forward documentation port to localhost
    cmds:
      - kubectl port-forward -n signapse service/documentation 8083:8000

  # Shell access tasks
  shell:client:
    desc: Open shell in client pod
    cmds:
      - kubectl exec -it -n signapse $(kubectl get pod -n signapse -l app=client -o jsonpath='{.items[0].metadata.name}') -- sh

  shell:server:
    desc: Open shell in server pod
    cmds:
      - kubectl exec -it -n signapse $(kubectl get pod -n signapse -l app=server -o jsonpath='{.items[0].metadata.name}') -- sh

  shell:registry:
    desc: Open shell in registry pod
    cmds:
      - kubectl exec -it -n signapse $(kubectl get pod -n signapse -l app=registry -o jsonpath='{.items[0].metadata.name}') -- sh

  # Validation tasks
  validate:
    desc: Validate all YAML files
    cmds:
      - kubectl apply --dry-run=client -f namespace.yaml
      - kubectl apply --dry-run=client -f volumes/
      - kubectl apply --dry-run=client -f config-maps/
      - kubectl apply --dry-run=client -f applications/
      - kubectl apply --dry-run=client -f ingress/

  # Update tasks
  update:all:
    desc: Update all resources (apply changes)
    cmds:
      - kubectl apply -f volumes/
      - kubectl apply -f config-maps/
      - kubectl apply -f applications/
      - kubectl apply -f ingress/

  # Troubleshooting tasks
  events:
    desc: Show recent events in namespace
    cmds:
      - kubectl get events -n signapse --sort-by='.lastTimestamp'

  top:pods:
    desc: Show resource usage of pods
    cmds:
      - kubectl top pods -n signapse

  top:nodes:
    desc: Show resource usage of nodes
    cmds:
      - kubectl top nodes
